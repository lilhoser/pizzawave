name: Build and Package pizzapi

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64
            runtime: linux-arm64
          - arch: x64
            runtime: linux-x64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Validate version
      run: |
        if [[ ! "${{ steps.get_version.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
          echo "Error: Invalid version format. Expected semver (e.g., 1.0.5), got: ${{ steps.get_version.outputs.version }}"
          exit 1
        fi

    - name: Restore dependencies
      run: dotnet restore pizzawave.sln

    - name: Build pizzapi for Linux ${{ matrix.arch }}
      run: |
        dotnet publish pizzapi/pizzapi.csproj \
          -c Release \
          -r ${{ matrix.runtime }} \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:IncludeNativeLibrariesForSelfExtract=true \
          -o ./publish/${{ matrix.arch }}

    - name: Build pizzalib for Linux ${{ matrix.arch }} (dependency)
      run: |
        dotnet publish pizzalib/pizzalib.csproj \
          -c Release \
          -r ${{ matrix.runtime }} \
          --self-contained true \
          -o ./publish/${{ matrix.arch }}

    - name: Create package directory structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/opt/pizzapi
        mkdir -p package/usr/bin
        mkdir -p package/usr/lib/systemd/system
        mkdir -p package/etc/pizzapi

    - name: Copy binaries to package
      run: |
        cp -r ./publish/${{ matrix.arch }}/* package/opt/pizzapi/
        chmod +x package/opt/pizzapi/pizzapi

    - name: Create DEBIAN control file
      run: |
        cat > package/DEBIAN/control << 'EOF'
        Package: pizzapi
        Version: ${{ steps.get_version.outputs.version }}
        Section: utils
        Priority: optional
        Architecture: ${{ matrix.arch == 'arm64' && 'arm64' || 'amd64' }}
        Depends: libicu-dev, libssl3, zlib1g, libfontconfig1, libx11-6, libx11-xcb1, libxcb1, libxext6, libxfixes3, libxi6, libxrender1, libxtst6, libxcb-glx0, libxcb-dri2-0, libxcb-dri3-0, libxcb-present0, libxcb-randr0, libxcb-shape0, libxcb-shm0, libxcb-sync1, libxcb-xfixes0, libxshmfence1, libxxf86vm1, libdrm2, libgbm1, libasound2
        Maintainer: PizzaWave Team
        Description: PizzaWave API for Linux (${{ matrix.arch }})
          A .NET-based API for radio scanning and call streaming.
        Installed-Size: $(du -sk package/opt/pizzapi | cut -f1)
        EOF

    - name: Create preinst script
      run: |
        cat > package/DEBIAN/preinst << 'EOF'
        #!/bin/bash
        set -e

        echo "Preparing to install PizzaPi API..."

        # Stop existing service if running
        if systemctl is-active --quiet pizzapi 2>/dev/null; then
          systemctl stop pizzapi
        fi
        EOF
        chmod 755 package/DEBIAN/preinst

    - name: Create postinst script
      run: |
        cat > package/DEBIAN/postinst << 'EOF'
        #!/bin/bash
        set -e

        echo "Installing PizzaPi API dependencies..."

        # Install system dependencies (app is self-contained, no .NET needed)
        apt-get update
        apt-get install -y libfontconfig1 libx11-6 libx11-xcb1 libxcb1 libxext6 libxfixes3 libxi6 libxrender1 libxtst6 libxcb-glx0 libxcb-dri2-0 libxcb-dri3-0 libxcb-present0 libxcb-randr0 libxcb-shape0 libxcb-shm0 libxcb-sync1 libxcb-xfixes0 libxshmfence1 libxxf86vm1 libdrm2 libgbm1 libasound2 || true

        # Create config directory if not exists
        mkdir -p /etc/pizzapi

        # Copy default config if not exists
        if [ ! -f /etc/pizzapi/appsettings.json ]; then
          cp /opt/pizzapi/appsettings.json.example /etc/pizzapi/appsettings.json 2>/dev/null || true
        fi

        echo ""
        echo "PizzaPi API installed successfully!"
        echo "Configuration: /etc/pizzapi/appsettings.json"
        echo "Run: /opt/pizzapi/pizzapi"
        echo ""
        EOF
        chmod 755 package/DEBIAN/postinst

    - name: Create prerm script
      run: |
        cat > package/DEBIAN/prerm << 'EOF'
        #!/bin/bash
        set -e

        echo "Stopping PizzaPi API service..."
        if systemctl is-active --quiet pizzapi; then
          systemctl stop pizzapi
        fi
        EOF
        chmod 755 package/DEBIAN/prerm

    - name: Create postrm script
      run: |
        cat > package/DEBIAN/postrm << 'EOF'
        #!/bin/bash
        set -e

        if [ "$1" = "purge" ]; then
          echo "Removing PizzaPi API configuration..."
          rm -rf /etc/pizzapi
          rm -rf /opt/pizzapi
        fi
        EOF
        chmod 755 package/DEBIAN/postrm

    - name: Create systemd service file
      run: |
        cat > package/usr/lib/systemd/system/pizzapi.service << 'EOF'
        [Unit]
        Description=PizzaWave API Service
        After=network.target

        [Service]
        Type=exec
        ExecStart=/opt/pizzapi/pizzapi
        WorkingDirectory=/opt/pizzapi
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal
        SyslogIdentifier=pizzapi
        User=root
        Environment=DOTNET_ENVIRONMENT=Production

        [Install]
        WantedBy=multi-user.target
        EOF

    - name: Create example config file
      run: |
        cat > package/etc/pizzapi/appsettings.json.example << 'EOF'
        {
          "Logging": {
            "LogLevel": {
              "Default": "Information",
              "Microsoft.AspNetCore": "Warning"
            }
          },
          "AllowedHosts": "*"
        }
        EOF

    - name: Build .deb package
      run: |
        # Fix ownership for DEBIAN directory
        fakeroot dpkg-deb --build package pizzapi_${{ steps.get_version.outputs.version }}_${{ matrix.arch }}.deb

    - name: Upload .deb artifact
      uses: actions/upload-artifact@v4
      with:
        name: pizzapi-deb-${{ matrix.arch }}
        path: pizzapi_${{ steps.get_version.outputs.version }}_${{ matrix.arch }}.deb
        retention-days: 30

    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: pizzapi_${{ steps.get_version.outputs.version }}_${{ matrix.arch }}.deb
        generate_release_notes: true
        append_body: true
