<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="using:pizzapi"
        xmlns:models="using:pizzalib"
        xmlns:ToolTip="using:Avalonia.Controls"
        x:Class="pizzapi.MainWindow"
        x:DataType="local:MainWindow"
        Title="PizzaPi"
        Width="800"
        Height="600"
        WindowStartupLocation="CenterScreen"
        Icon="/images/logo-small.png">
    <Window.Resources>
        <local:BoolToDoubleConverter x:Key="BoolToDoubleConverter" />
        <local:BoolToStringConverter x:Key="BoolToStringConverter" />
        <local:BoolToColorConverter x:Key="BoolToColorConverter" />
        <local:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        
        <!-- Data template for group headers -->
        <DataTemplate x:Key="HeaderTemplate" x:DataType="local:CallGroupItem">
            <Button Background="#1a4a1a"
                    Padding="10,8"
                    Margin="0,4,0,0"
                    Cursor="Hand"
                    Click="OnGroupHeaderClicked"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Left"
                    Classes="header-button">
                <Button.Styles>
                    <Style Selector="Button.header-button">
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Background" Value="#1a4a1a"/>
                        <Setter Property="Padding" Value="10,8"/>
                        <Setter Property="Margin" Value="0,4,0,0"/>
                        <Setter Property="HorizontalAlignment" Value="Stretch"/>
                        <Setter Property="HorizontalContentAlignment" Value="Left"/>
                    </Style>
                    <Style Selector="Button.header-button:pointerover">
                        <Setter Property="Background" Value="#2a5a2a"/>
                    </Style>
                    <Style Selector="Button.header-button:pressed">
                        <Setter Property="Background" Value="#3a6a3a"/>
                    </Style>
                    <Style Selector="Button.header-button:focus">
                        <Setter Property="Background" Value="#1a4a1a"/>
                        <Setter Property="BorderThickness" Value="0"/>
                    </Style>
                </Button.Styles>
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <!-- Expand/Collapse chevron - use two paths with visibility toggle to prevent shift -->
                    <Grid Width="16" Height="16">
                        <!-- Collapsed state: chevron pointing right -->
                        <Path Data="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"
                              Fill="#00ff00"
                              Width="16"
                              Height="16"
                              IsVisible="{Binding IsExpanded, Converter={StaticResource InvertedBoolConverter}}"/>
                        <!-- Expanded state: chevron pointing down -->
                        <Path Data="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"
                              Fill="#00ff00"
                              Width="16"
                              Height="16"
                              IsVisible="{Binding IsExpanded}"/>
                    </Grid>
                    <TextBlock Text="{Binding HeaderText}"
                               FontSize="14"
                               FontWeight="Bold"
                               Foreground="#00ff00" />
                </StackPanel>
            </Button>
        </DataTemplate>
        
		<!-- Data template for call items -->
<DataTemplate x:Key="CallTemplate" x:DataType="local:CallGroupItem">
    <Border Background="{Binding Call.IsAlertMatch, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#4a2a2a|#3a3a3a'}"
            BorderBrush="#555"
            BorderThickness="0,0,0,1"
            CornerRadius="0"
            Padding="4,8,8,8"
            Margin="0,4,0,0"
            Cursor="Hand"
            PointerReleased="OnCallRowClicked"
            HorizontalAlignment="Stretch">

        <Grid HorizontalAlignment="Stretch">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="40"/>
                <ColumnDefinition Width="40"/>
                <ColumnDefinition Width="40"/>
                <ColumnDefinition Width="40"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Talkgroup -->
            <TextBlock Grid.Row="0" Grid.ColumnSpan="7"
                       Text="{Binding Call.FriendlyTalkgroup}"
                       FontSize="{DynamicResource CurrentFontSize}"
                       FontWeight="Bold"
                       Foreground="#00d2ff"
                       IsVisible="{Binding ShowTalkgroup}"
                       HorizontalAlignment="Left"/>

            <!-- Transcription - flush left to window edge, spans full width under icons -->
            <TextBlock Grid.Row="1" Grid.ColumnSpan="7"
                       Text="{Binding Call.Transcription}"
                       TextWrapping="Wrap"
                       FontSize="{DynamicResource CurrentFontSize}"
                       Foreground="White"
                       MaxWidth="900"
                       HorizontalAlignment="Left"
                       TextAlignment="Left"
                       Margin="0,8,0,4"/>

            <!-- Timestamp + Frequency -->
            <StackPanel Grid.Row="2" Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <TextBlock Text="{Binding Call.CallTime}" FontSize="11" Foreground="Gray"/>
                <TextBlock Text="{Binding Call.FriendlyFrequency}" FontSize="11" Foreground="#ffaa00"/>
            </StackPanel>

            <!-- PIN -->
            <Border Grid.Row="2" Grid.Column="2" Width="40" Height="32" VerticalAlignment="Center"
                    Background="Transparent" Cursor="Hand" PointerReleased="OnPinClicked"
                    ToolTip.Tip="Pin / unpin this call">
                <Border.Styles>
                    <Style Selector="Border:pointerover">
                        <Setter Property="Background" Value="#404040"/>
                    </Style>
                </Border.Styles>
                <Path Data="M16 12V4H17V2H7V4H8V12L6 14V16H11.2V22H12.8V16H18V14L16 12M8.8 14L10 12.8V4H14V12.8L15.2 14H8.8Z"
                      Fill="{Binding Call.IsPinned, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#ff6b6b|#666666'}"
                      Width="16" Height="16" HorizontalAlignment="Center" VerticalAlignment="Center"
                      IsHitTestVisible="False"/>
            </Border>

            <!-- SAVE -->
            <Border Grid.Row="2" Grid.Column="3" Width="40" Height="32" VerticalAlignment="Center"
                    Background="Transparent" Cursor="Hand" PointerReleased="OnSaveClicked"
                    ToolTip.Tip="Save audio + transcription">
                <Border.Styles>
                    <Style Selector="Border:pointerover">
                        <Setter Property="Background" Value="#404040"/>
                    </Style>
                </Border.Styles>
                <Path Data="M15 9H5V5H15M12 19A3 3 0 0 1 9 16A3 3 0 0 1 12 13A3 3 0 0 1 15 16A3 3 0 0 1 12 19M17 3H5C3.89 3 3 3.9 3 5V19A2 2 0 0 0 5 21H19A2 2 0 0 0 21 19V7L17 3Z"
                      Fill="#4CAF50" Width="16" Height="16" HorizontalAlignment="Center" VerticalAlignment="Center"
                      IsHitTestVisible="False"/>
            </Border>

            <!-- COPY -->
            <Border Grid.Row="2" Grid.Column="4" Width="40" Height="32" VerticalAlignment="Center"
                    Background="Transparent" Cursor="Hand" PointerReleased="OnCopyClicked"
                    ToolTip.Tip="Copy transcription to clipboard">
                <Border.Styles>
                    <Style Selector="Border:pointerover">
                        <Setter Property="Background" Value="#404040"/>
                    </Style>
                </Border.Styles>
                <Path Data="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1M19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5M19 21H8V7H19V21Z"
                      Fill="#4CAF50" Width="16" Height="16" HorizontalAlignment="Center" VerticalAlignment="Center"
                      IsHitTestVisible="False"/>
            </Border>

            <!-- PLAY / STOP -->
            <Border Grid.Row="2" Grid.Column="5" Width="40" Height="32" VerticalAlignment="Center"
                    Background="Transparent" Cursor="Hand" PointerReleased="OnCallRowClicked"
                    ToolTip.Tip="Play / stop audio">
                <Border.Styles>
                    <Style Selector="Border:pointerover">
                        <Setter Property="Background" Value="#404040"/>
                    </Style>
                </Border.Styles>
                <Grid Width="16" Height="16" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Path Data="M8 5.14V19.14L19 12.14L8 5.14Z"
                          Fill="#4CAF50"
                          IsVisible="{Binding Call.IsAudioPlaying, Converter={StaticResource InvertedBoolConverter}}"/>
                    <Path Data="M6 6H18V18H6V6Z"
                          Fill="#f44336"
                          IsVisible="{Binding Call.IsAudioPlaying}"/>
                </Grid>
            </Border>

            <!-- Duration -->
            <TextBlock Grid.Row="2" Grid.Column="6" VerticalAlignment="Center"
                       FontSize="11" Foreground="#4CAF50" Margin="8,0,0,0">
                <TextBlock.Text>
                    <Binding Path="Call.Duration" StringFormat="{}{0}s"/>
                </TextBlock.Text>
            </TextBlock>
        </Grid>
    </Border>
</DataTemplate>

		        
        <!-- Data template selector -->
        <local:CallGroupItemTemplateSelector x:Key="CallGroupTemplateSelector"
                                             HeaderTemplate="{StaticResource HeaderTemplate}"
                                             CallTemplate="{StaticResource CallTemplate}" />
    </Window.Resources>
    <Grid>
        <!-- Main Content Area -->
        <ScrollViewer VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled">
            <Border Padding="10,10,10,80">
                <StackPanel Spacing="8">
                    <!-- Recent Calls List -->
                    <ItemsControl ItemsSource="{Binding GroupedCalls}"
                                  ItemTemplate="{StaticResource CallGroupTemplateSelector}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Spacing="8" Orientation="Vertical"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.Styles>
                            <Style Selector="ContentPresenter">
                                <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            </Style>
                        </ItemsControl.Styles>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- Footer Status (bottom) -->
        <Border VerticalAlignment="Bottom"
                Background="#222"
                Padding="8"
                BorderBrush="#444"
                BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="300" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <!-- Left side: Stats -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="15">
                    <StackPanel Orientation="Horizontal" Spacing="5">
                        <TextBlock Text="Calls:" Foreground="White" />
                        <TextBlock Text="{Binding CallsReceivedCount}" Foreground="#00d2ff" FontWeight="Bold" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="5">
                        <TextBlock Text="Alerts:" Foreground="White" />
                        <TextBlock Text="{Binding AlertsTriggeredCount}" Foreground="#ffaa00" FontWeight="Bold" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="5">
                        <TextBlock Text="{Binding UsageText}" Foreground="White" />
                    </StackPanel>
                </StackPanel>
                <!-- Status text (truncated) -->
                <TextBlock Grid.Column="1"
                           Text="{Binding StatusText}"
                           Foreground="#00ff00"
                           TextTrimming="CharacterEllipsis"
                           TextAlignment="Left"
                           Margin="15,0,0,0" />
                <!-- Spacer -->
                <Grid Grid.Column="2" />
                <!-- Mode indicator -->
                <Border Grid.Column="3"
                        Background="{Binding ModeIndicatorColor}"
                        CornerRadius="4"
                        Padding="8,2"
                        VerticalAlignment="Center"
                        Margin="15,0,5,0">
                    <TextBlock Text="{Binding ModeIndicatorText}"
                               Foreground="Black"
                               FontWeight="Bold"
                               FontSize="11" />
                </Border>
                <!-- Bell icon -->
                <Path Grid.Column="4"
                      Data="M12 22A2 2 0 0 0 14 20H10A2 2 0 0 0 12 22M18 16V11A6 6 0 0 0 13 5.03V5A1 1 0 0 0 11 5V5.03A6 6 0 0 0 6 11V16L4 18V19H20V18L18 16Z"
                      Fill="{Binding BellColor}"
                      Width="18"
                      Height="18"
                      Margin="5,-5,5,0"
					  VerticalAlignment="Center"
                      ToolTip.Tip="{Binding BellToolTipText}"
                      Cursor="Hand"
                      PointerReleased="OnBellClicked"/>
                <!-- Right side: Version -->
                <TextBlock Grid.Column="5"
                           Text="{Binding VersionString}"
                           Foreground="#888"
                           FontSize="11"
                           VerticalAlignment="Center"
                           Margin="5,0,0,0" />
            </Grid>
        </Border>

        <!-- Menu Container (overlay) - placed last in Grid to be on top -->
        <StackPanel HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Margin="5,5,0,0">
            <!-- Hamburger Menu Button -->
            <Button x:Name="HamburgerButton"
                    Content=""
                    Click="OnMenuButtonClicked"
                    Background="Transparent"
                    Foreground="White"
                    Width="40"
                    Height="40"
                    Padding="0"
					Cursor="Hand"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top">
                <Button.Template>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
                            <Path Data="M3 6H21V8H3V6M3 11H21V13H3V11M3 16H21V18H3V16Z"
                                  Fill="White"
                                  Width="24"
                                  Height="24"/>
                        </Border>
                    </ControlTemplate>
                </Button.Template>
            </Button>
        </StackPanel>

        <!-- Menu Panel (overlay, appears below hamburger button) - placed last in Grid to be on top -->
        <Border x:Name="MenuPanel"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Margin="5,45,0,0"
                Width="220"
                MaxHeight="500"
                Background="#2d2d2d"
                BorderThickness="1"
                BorderBrush="#555"
                Padding="10"
                IsVisible="{Binding MenuVisible}"
                Opacity="{Binding MenuVisible, Converter={StaticResource BoolToDoubleConverter}}">
            <StackPanel>
                <TextBlock Text="MENU"
                           FontSize="16"
                           FontWeight="Bold"
                           Foreground="White"
                           Margin="0,0,0,10" />

                <Button Content="Import Talkgroups..."
                        Width="200"
                        Margin="0,5,0,0"
                        Click="OnImportTalkgroupsClicked"
                        Tag="Import Talkgroups" />

                <Button Content="Settings..."
                        Width="200"
                        Margin="0,5,0,0"
                        Click="OnSettingsClicked" />

                <Button Content="Alerts..."
                        Width="200"
                        Margin="0,5,0,0"
                        Click="OnAlertsClicked" />

                <Button x:Name="OpenOfflineButton"
                        Content="Open Offline Capture..."
                        Width="200"
                        Margin="0,5,0,0"
                        Click="OnOpenOfflineCaptureClicked"
                        ToolTip.Tip="Load historical calls from a capture folder" />

                <Button x:Name="ReturnToLiveButton"
                        Content="Return to Live Mode"
                        Width="200"
                        Margin="0,5,0,0"
                        Click="OnReturnToLiveModeClicked"
                        ToolTip.Tip="Return to live call monitoring"
                        IsVisible="False" />

                <Button Content="Cleanup..."
                        Width="200"
                        Margin="0,5,0,0"
                        Click="OnCleanupClicked"
                        ToolTip.Tip="Cleanup captured audio files" />

                <!-- View button with popup submenu -->
                <Button x:Name="ViewButton"
                        Content="View →"
                        Width="200"
                        Margin="0,5,0,0"
                        Click="OnViewButtonClicked"
                        Focusable="False" />

                <Popup x:Name="ViewSubMenuPopup"
                       PlacementTarget="{Binding ElementName=ViewButton}"
                       Placement="Right"
                       IsOpen="False"
                       Focusable="False">
                    <Border Background="#2d2d2d"
                            BorderThickness="1"
                            BorderBrush="#555"
                            CornerRadius="4"
                            Padding="5"
                            Focusable="False">
                        <Grid Focusable="False">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="200" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <!-- Left column: Main menu -->
                            <StackPanel Grid.Column="0" Focusable="False">
                                <Button Content="Clear Calls"
                                        Width="190"
                                        HorizontalContentAlignment="Left"
                                        Click="OnClearClicked"
                                        Focusable="False" />
                                <Button Content="Log"
                                        Width="190"
                                        HorizontalContentAlignment="Left"
                                        Click="OnViewLogClicked"
                                        Focusable="False" />
                                <Separator Margin="0,5" Focusable="False" />
                                <Button Content="Sort →"
                                        Width="190"
                                        HorizontalContentAlignment="Left"
                                        Click="OnSortButtonClicked"
                                        Focusable="False" />
                                <Button Content="Group By →"
                                        Width="190"
                                        HorizontalContentAlignment="Left"
                                        Click="OnGroupByButtonClicked"
                                        Focusable="False" />
                                <Separator Margin="0,5" Focusable="False" />
                                <StackPanel Orientation="Horizontal" Margin="0,2,0,0" Focusable="False">
                                    <Button Content="A-"
                                            Width="60"
                                            ToolTip.Tip="Decrease font size"
                                            Click="OnDecreaseFontSizeClicked"
                                            Focusable="False" />
                                    <Button Content="A+"
                                            Width="60"
                                            Margin="5,0,0,0"
                                            ToolTip.Tip="Increase font size"
                                            Click="OnIncreaseFontSizeClicked"
                                            Focusable="False" />
                                </StackPanel>
                                <Separator Margin="0,5" Focusable="False" />
                                <Button Content="Collapse/Expand All"
                                        Width="190"
                                        HorizontalContentAlignment="Left"
                                        Click="OnCollapseExpandAllClicked"
                                        Focusable="False" />
                            </StackPanel>
                            <!-- Right column: Sort submenu -->
                            <Border x:Name="SortSubMenuBorder"
                                    Grid.Column="1"
                                    Background="#2d2d2d"
                                    BorderThickness="1"
                                    BorderBrush="#555"
                                    CornerRadius="4"
                                    Padding="5"
                                    IsVisible="False"
                                    Margin="5,0,0,0"
                                    Focusable="False">
                                <StackPanel Focusable="False">
                                    <Button x:Name="SortNewestButton"
                                            Content="✓ Time (newest first)"
                                            Width="170"
                                            HorizontalContentAlignment="Left"
                                            Click="OnSortByTimeNewestClicked"
                                            Focusable="False" />
                                    <Button x:Name="SortOldestButton"
                                            Content="  Time (oldest first)"
                                            Width="170"
                                            HorizontalContentAlignment="Left"
                                            Click="OnSortByTimeOldestClicked"
                                            Focusable="False" />
                                    <Button x:Name="SortTalkgroupButton"
                                            Content="  Talkgroup (A-Z)"
                                            Width="170"
                                            HorizontalContentAlignment="Left"
                                            Click="OnSortByTalkgroupClicked"
                                            Focusable="False" />
                                    <Separator Margin="0,5" />
                                    <Button x:Name="AlwaysPinAlertsButton"
                                            Content="✓ Always pin alert matches"
                                            Width="170"
                                            HorizontalContentAlignment="Left"
                                            Click="OnAlwaysPinAlertsClicked"
                                            Focusable="False" />
                                </StackPanel>
                            </Border>
                            <!-- Right column: Group By submenu -->
                            <Border x:Name="GroupBySubMenuBorder"
                                    Grid.Column="1"
                                    Background="#2d2d2d"
                                    BorderThickness="1"
                                    BorderBrush="#555"
                                    CornerRadius="4"
                                    Padding="5"
                                    IsVisible="False"
                                    Margin="5,0,0,0"
                                    Focusable="False">
                                <StackPanel Focusable="False">
                                    <Button x:Name="GroupNoneButton"
                                            Content="✓ None (flat list)"
                                            Width="170"
                                            HorizontalContentAlignment="Left"
                                            Click="OnGroupByNoneClicked"
                                            Focusable="False" />
                                    <Button x:Name="GroupTalkgroupButton"
                                            Content="  Talkgroup"
                                            Width="170"
                                            HorizontalContentAlignment="Left"
                                            Click="OnGroupByTalkgroupClicked"
                                            Focusable="False" />
                                    <Button x:Name="GroupTimeOfDayButton"
                                            Content="  Time of Day"
                                            Width="170"
                                            HorizontalContentAlignment="Left"
                                            Click="OnGroupByTimeOfDayClicked"
                                            Focusable="False" />
                                    <Button x:Name="GroupSourceButton"
                                            Content="  Source"
                                            Width="170"
                                            HorizontalContentAlignment="Left"
                                            Click="OnGroupBySourceClicked"
                                            Focusable="False" />
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Border>
                </Popup>

                <Button Content="Exit"
                        Width="200"
                        Margin="0,5,0,0"
                        Click="OnExitClicked" />
            </StackPanel>
        </Border>
    </Grid>
</Window>
